# 6장: 지연

---

## 00. 들어가며

이 장은 **응답 시간이 어떻게 지연되는지**와 그 지연을 줄이는 방법을 다룬다.  
핵심은 두 가지다:
- **이벤트 카운트**를 줄이고
- **이벤트 시간을** 줄이는 것

케빈의 청구서 사례를 통해 카운트·시간·대기 지연·대기열 모델을 함께 살펴본다.

---

## 01. 케빈의 청구서 생성: 카운트와 시간

### 정상 상태 프로파일(월초)
- 총 41초
- 블록 읽기: 81,964회, 0.000464초/회 (매우 빠르지만 횟수가 많음)
- 나머지 이벤트는 미미

### 문제 상태(월말)
- 블록 읽기 평균 시간이 느려지거나(0.004초 등)  
  또는 블록 읽기 **카운트**가 폭증해 청구서 생성이 5분(300초)까지 증가

### 암달의 법칙 적용
- 블록 읽기 비중이 크므로 **0.000464 → 0.004**로 10배 느려지면 전체도 대략 10배 이상 느려짐.
- 반대로 카운트를 82,000 → 3,000으로 줄이면, 같은 시간에서도 40배 이상 단축(1초대) 가능.

### 카운트 줄이기
- 비효율적 데이터 접근 알고리즘을 수정해 불필요한 블록 읽기를 제거.
- 결과: 정상 시 1초 내외, 블록 읽기 느려져도 10초 수준으로 제한 → 월말에도 버팀.

**교훈**: 빠른 I/O라도 너무 많이 호출하면 느려진다. **카운트 감소**가 시간 감소보다 큰 효과를 낼 때가 많다.

---

## 02. 대기 지연(Queueing Delay)

블록 읽기 시간이 월초보다 월말에 늘어나는 이유:
- SSD/스토리지에 **대기열**이 생기기 때문.  
- 요청이 몰리면 서비스 대기열 길이가 늘어 **대기 지연(Q)**이 커진다.

예시:
- 서비스 시간(S) = 0.000464초
- 대기열에 4개가 대기 중이면 내 호출은 4.5S ≈ 0.002088초가 됨
- 대기 지연이 응답 시간(R)을 결정하는 주요 요인이 됨

---

## 03. 대기열 이론 한눈에 보기 (M/M/2 예시)

- **트래픽 강도 p**: 시스템이 얼마나 바쁜지(0~1). 서비스 채널 2개면 p = λ / (2μ).
- **응답 시간 R = Q + S**  
  - S: 서비스 시간(자체 처리 시간)  
  - Q: 대기 지연(줄 서는 시간)

그래프 특징:
- 부하가 낮을 때는 R이 완만히 증가하지만, **p→1**에 가까워지면 R이 급격히 증가(하키 스틱 모양).
- 케빈 사례에서 p≈0.88일 때 Q≈3.5S → R≈4.5S (0.002초 수준).
- **사용률을 낮추거나**(호출 수/카운트 감소) **서비스 채널을 늘리거나**(더 빠른 스토리지/병렬 채널) 해야 R을 안정화할 수 있다.

---

## 04. 일관성 지연(coherency delay)

- 분산/멀티노드 시스템에서 캐시 일관성 확인, 원격 복사 등의 추가 작업이 **서비스 시간 S 자체**를 늘린다.
- S가 커지면 응답 시간 R이 늘어날 뿐 아니라 **트래픽 강도 p도 증가**해 대기 지연 Q까지 커지는 이중 악화가 발생.
- 캐시 일관성/동기화 비용을 줄이면 부하가 높을 때 특히 효과가 크다(쌍곡선의 오른쪽 급상승 구간을 피할 수 있음).

---

## 05. 지연과 처리량

- 대기 지연은 부하 추가 시 **한계 효용**을 감소시켜 처리량 곡선을 휘게 만든다.
- 일관성 지연까지 더해지면 처리량이 역행(더 많은 부하 → 처리량 감소)하는 구간이 나타날 수 있다.
- 통신/동기화 채널 수가 **제곱으로 증가**하는 패턴(예: 노드가 많을수록 N² 관계)도 램프 문제를 일으킨다.

---

## 06. 실무 적용 포인트

- **카운트 줄이기 먼저**: 불필요 쿼리/IO/루프/데이터 반환을 제거.
- **시간 줄이기**: 인덱스, 캐시, 네트워크/스토리지 튜닝, 하드웨어 증설.
- **기준선 확보**: 정상 시 프로파일을 저장해 월말/문제 시점과 비교.
- **대기열 감시**: 스토리지/네트워크 사용률과 대기열 길이를 모니터링해 p가 급등하지 않도록 관리.
- **암달 체크**: 응답 시간의 큰 비중을 차지하는 이벤트가 무엇인지 항상 확인.

---

[← 이전: 5장](05-real-world-examples.md) | [다음: 7장 →](07-waste.md)
